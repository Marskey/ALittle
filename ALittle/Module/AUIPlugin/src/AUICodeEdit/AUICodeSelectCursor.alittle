
namespace AUIPlugin;

public class AUICodeSelectCursor
{
    private AUICodeEdit _edit;

    // 选中光标的范围
    private int _it_line_start;
    private int _it_char_start;
    private int _it_line_end;
    private int _it_char_end;
    private bool _clear_quad = true;

	public ctor(AUICodeEdit edit)
    {
        this._edit = edit;
    }

    private fun ClearQuad()
    {
        if (this._clear_quad) return;
        this._clear_quad = true;

        if (this._it_line_start != null && this._it_line_end != null)
        {
            if (this._it_line_start < this._it_line_end)
            {
                for (var i = this._it_line_start; i <= this._it_line_end; 1)
                    this._edit.line_list[i].quad.visible = false;
            }
            else
            {
                for (var i = this._it_line_end; i <= this._it_line_start; 1)
                    this._edit.line_list[i].quad.visible = false;
            }
        }
    }

    private fun SetQuad()
    {
        var it_line_start = this._it_line_start;
        var it_char_start = this._it_char_start;
        var it_line_end = this._it_line_end;
        var it_char_end = this._it_char_end;

        var swap = false;
        if (it_line_start > it_line_end)
            swap = true;
        elseif (it_line_start == it_line_end)
            swap = it_char_start > it_char_end;
        if (swap)
        {
            var temp = it_line_start;
            it_line_start = it_line_end;
            it_line_end = temp;

            temp = it_char_start;
            it_char_start = it_char_end;
            it_char_end = temp;
        }

        if (it_line_start == it_line_end)
        {
            if (this._it_char_start == this._it_char_end) return;
            var line = this._edit.line_list[it_line_start];
            if (line.char_count == 0) return;
            line.quad.visible = true;
            this._clear_quad = false;
            line.quad.x = line.char_list[it_char_start + 1].pre_width;
            line.quad.width = line.char_list[it_char_end].pre_width + line.char_list[it_char_end].width - line.quad.x;
            return;
        }
        for (var i = it_line_start; i <= it_line_end; 1)
        {
            var line = this._edit.line_list[i];
            if (line.char_count > 0)
            {
                if (i == it_line_start)
                {
                    if (it_char_start < line.char_count)
                    {
                        line.quad.visible = true;
                        this._clear_quad = false;
                        line.quad.x = line.char_list[it_char_start + 1].pre_width;
                        line.quad.width = line.container.width - line.quad.x;   
                    }
                }
                elseif (i == it_line_end)
                {
                    if (it_char_end > 0)
                    {
                        line.quad.visible = true;
                        this._clear_quad = false;
                        line.quad.x = 0;
                        line.quad.width = line.char_list[it_char_end].pre_width + line.char_list[it_char_end].width;   
                    }
                }
                else
                {
                    line.quad.visible = true;
                    this._clear_quad = false;
                    line.quad.x = 0;
                    line.quad.width = line.container.width;
                }   
            }
        }
    }

    public get line_start() : int { return this._it_line_start; }
    public get char_start() : int { return this._it_char_start; }
    public get line_end() : int { return this._it_line_end; }
    public get char_end() : int { return this._it_char_end; }

    public fun StartLineChar(int line, int char)
    {
        this.Hide();
        if (this._edit.line_count == 0)
            return;
        this._it_line_start = line;
        this._it_char_start = char;
    }

    public fun UpdateLineChar(int line, int char)
    {
        this.ClearQuad();
        this._it_line_end = line;
        this._it_char_end = char;
        this.SetQuad();
    }

    public fun StartOffsetXY(double x, double y)
    {
        this.Hide();
        if (this._edit.line_count == 0)
            return;
        this._it_line_start, this._it_char_start = this._edit.CalcLineAndChar(x, y);
    }

    public fun UpdateOffsetXY(double x, double y)
    {
        this.ClearQuad();
        if (this._it_line_start == null) return;

        this._it_line_end, this._it_char_end = this._edit.CalcLineAndChar(x, y);
        this.SetQuad();
    }

    // 复制选中文本
    public fun GetSelectText() : string
    {
        if (this._it_line_start == null) return null;

        var it_line_start = this._it_line_start;
        var it_char_start = this._it_char_start;
        var it_line_end = this._it_line_end;
        var it_char_end = this._it_char_end;

        var swap = false;
        if (it_line_start > it_line_end)
            swap = true;
        elseif (it_line_start == it_line_end)
            swap = it_char_start > it_char_end;
        if (swap)
        {
            var temp = it_line_start;
            it_line_start = it_line_end;
            it_line_end = temp;

            temp = it_char_start;
            it_char_start = it_char_end;
            it_char_end = temp;
        }

        if (it_line_start == it_line_end)
        {
            if (this._it_char_start == this._it_char_end) return "";
            var line = this._edit.line_list[it_line_start];
            if (line.char_count == 0) return "";
            var text = "";
            for (var i = it_char_start + 1; i <= it_char_end; 1)
                text = text..line.char_list[i].char;
            return text;
        }

        var text = "";
        for (var i = it_line_start; i <= it_line_end; 1)
        {
            var line = this._edit.line_list[i];
            if (line.char_count > 0)
            {
                if (i == it_line_start)
                {
                    for (var j = it_char_start + 1; j <= line.char_count; 1)
                        text = text..line.char_list[j].char;
                }
                elseif (i == it_line_end)
                {
                    for (var j = 1; j <= it_char_end; 1)
                        text = text..line.char_list[j].char;
                }
                else
                {
                    for (var j = 1; j <= line.char_count; 1)
                        text = text..line.char_list[j].char;
                }   
            }
        }
        return text;
    }

    public fun DeleteSelect(bool need_revoke, [Nullable]ALittle.RevokeBind revoke_bind) : bool, int, int
    {
        if (this._it_line_start == null) return false, null, null;

        if (this._it_line_start == this._it_line_end)
        {
            if (this._it_char_start == this._it_char_end)
            {
                this.Hide();
                return false, null, null;
            }

            var line = this._edit.line_list[this._it_line_start];
            if (line == null) return false, null, null;

            if (this._edit.language != null)
                this._edit.language.DeleteText(this._it_line_start, this._it_char_start, this._it_line_end, this._it_char_end);

            var old_it_line_start = this._it_line_start;
            var old_it_char_start = this._it_char_start;
            var old_it_line_end = this._it_line_end;
            var old_it_char_end = this._it_char_end;

            var it_line_start = this._it_line_start;
            // 交换
            var it_char_start = this._it_char_start;
            var it_char_end = this._it_char_end;
            if (it_char_start > it_char_end)
            {
                var temp = it_char_start;
                it_char_start = it_char_end;
                it_char_end = temp;
            }

            // 先隐藏
            this.Hide();
            
            // 计算长度
            var acc_width = 0.0;
            for (var i = it_char_start + 1; i <= it_char_end; 1)
                acc_width += line.char_list[i].width;

            // 移动
            for (var i = it_char_end + 1; i <= line.char_count; 1)
            {
                var char = line.char_list[i];
                char.pre_width -= acc_width;
                if (char.text != null) char.text.x -= acc_width;
            }

            // 移除
            var revoke_content = "";
            for (var i = it_char_start + 1; i <= it_char_end; 1)
            {
                var char = line.char_list[i];
                revoke_content = revoke_content..char.char;
                if (char.text != null) line.container.RemoveChild(char.text);
            }
            var count = it_char_end - it_char_start;
            line.char_count -= count;
            ALittle.List_Splice(line.char_list, it_char_start + 1, count);

            var last_char = line.char_list[line.char_count];
            if (last_char != null)
                line.container.width = last_char.pre_width + last_char.width;
            else
                line.container.width = 0;
            var rejust = true;
            for (var index, line_info in this._edit.line_list)
            {
                if (line_info.container.width > line.container.width)
                {
                    rejust = false;
                    break;
                }
            }
            if (rejust)
            {
                this._edit.container.width = line.container.width;
                this._edit.RejustScrollBar();
            }

            if (need_revoke)
            {
                var revoke = new AUICodeDeleteSelectRevoke(this._edit, this._edit.cursor, this
                            , old_it_line_start, old_it_char_start, old_it_line_end, old_it_char_end
                            , it_line_start, it_char_start, revoke_content);
                if (revoke_bind != null)
                    revoke_bind.PushRevoke(revoke);
                else
                    this._edit.revoke_list.PushRevoke(revoke);
            }

            return true, it_line_start, it_char_start;
        }

        if (this._edit.language != null)
            this._edit.language.DeleteText(this._it_line_start, this._it_char_start, this._it_line_end, this._it_char_end);

        var old_it_line_start = this._it_line_start;
        var old_it_char_start = this._it_line_start;
        var old_it_line_end = this._it_line_end;
        var old_it_char_end = this._it_char_end;

        // 交换
        var it_line_start = this._it_line_start;
        var it_char_start = this._it_char_start;
        var it_line_end = this._it_line_end;
        var it_char_end = this._it_char_end;
        if (it_line_start > it_line_end)
        {
            var temp = it_line_start;
            it_line_start = it_line_end;
            it_line_end = temp;

            temp = it_char_start;
            it_char_start = it_char_end;
            it_char_end = temp;
        }

        // 先隐藏
        this.Hide();

        // 先删除中间的行
        var revoke_center = "";
        var line_count = it_line_end - it_line_start - 1;
        if (line_count > 0)
        {
            for (var it_line = it_line_start + 1; it_line < it_line_end; 1)
            {
                var line = this._edit.line_list[it_line];
                for (var it_char = 1; it_char <= line.char_count; 1)
                    revoke_center = revoke_center..line.char_list[it_char].char;
                this._edit.code_linear.RemoveChild(line.container);
            }   
            ALittle.List_Splice(this._edit.line_list, it_line_start + 1, line_count);
            this._edit.line_count -= line_count;
            it_line_end -= line_count;
        }
        // 删除开始行
        var revoke_start = "";
        var start_line = this._edit.line_list[it_line_start];
        for (var it_char = it_char_start + 1; it_char <= start_line.char_count; 1)
        {
            var char = start_line.char_list[it_char];
            revoke_start = revoke_start..char.char;
            if (char.text != null) start_line.container.RemoveChild(char.text);
        }
        var count = start_line.char_count - it_char_start;
        start_line.char_count -= count;
        ALittle.List_Splice(start_line.char_list, it_char_start + 1, count);

        // 2. 下一行拼到当前行的尾部
        var end_line = this._edit.line_list[it_line_end];
        var pre_width = 0.0;
        var last_char = start_line.char_list[start_line.char_count];
        if (last_char != null)
            pre_width = last_char.pre_width + last_char.width;
        
        var revoke_end = "";
        for (var i = 1; i <= it_char_end; 1)
            revoke_end = revoke_end..end_line.char_list[i].char;

        for (var i = it_char_end + 1; i <= end_line.char_count; 1)
        {
            var char = end_line.char_list[i];
            char.pre_width = pre_width;
            if (char.text != null)
            {
                char.text.x = pre_width;
                start_line.container.AddChild(char.text);
            }
            elseif (char.width > 0)
            {
                start_line.container.CreateAndAdd(char);
            }
            pre_width += char.width;
            start_line.char_count += 1;
            start_line.char_list[start_line.char_count] = char;
        }
        start_line.container.width = pre_width;
        this._edit.code_linear.RemoveChild(end_line.container);
        this._edit.line_count -= 1;
        ALittle.List_Remove(this._edit.line_list, it_line_end);
        // 3. 下面的行依次往前移动
        // for (var i = it_line_end; i <= this._edit.line_count; 1)
        //    this._edit.line_list[i].container.y -= this._edit.line_height * (line_count + 1);

        // 从新计算宽度
        var max_width = 0.0;
        var text = "";
        for (var index, line in this._edit.line_list)
        {
            if (max_width < line.container.width)
                max_width = line.container.width;
            text = text..index;
            for (var kk, char in line.char_list)
                text = text..char.char;
        }
        this._edit.container.width = max_width;
        this._edit.RejustScrollBar();

        if (need_revoke)
        {
            var revoke = new AUICodeDeleteSelectRevoke(this._edit, this._edit.cursor, this
                , old_it_line_start, old_it_char_start, old_it_line_end, old_it_char_end
                , it_line_start, it_char_start, revoke_start..revoke_center..revoke_end);
            if (revoke_bind != null)
                revoke_bind.PushRevoke(revoke);
            else
                this._edit.revoke_list.PushRevoke(revoke);
        }

        return true, it_line_start, it_char_start;
    }

    public fun TryHide()
    {
        if (this._it_line_start == null
            || this._it_line_end == null
            || this._it_char_start == null
            || this._it_char_end == null)
        {
            this.Hide();
            return;
        }

        if (this._it_line_start == this._it_line_end
            && this._it_char_start == this._it_char_end)
        {
            this.Hide();
            return;
        }
    }

	public fun Hide()
	{
        this.ClearQuad();
        this._clear_quad = true;
        this._it_line_start = null;
        this._it_char_start = null;
        this._it_line_end = null;
        this._it_char_end = null;
    }
}
